<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Player - V18 Smart Resume</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .active-chunk { 
            background-color: #dbeafe !important; 
            border-bottom: 3px solid #2563eb !important; 
            color: #1d4ed8;
            font-weight: 700;
            border-radius: 4px;
        }
        .disabled-chunk {
            opacity: 0.3;
            text-decoration: line-through;
            background-color: #f1f5f9;
            pointer-events: none;
        }
        .disabled-chunk button {
            pointer-events: auto;
            text-decoration: none;
            opacity: 1;
        }
        .library-item:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .speaking-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        #transcriptArea { scroll-behavior: smooth; }
        input[type=range] { accent-color: #2563eb; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

<div id="app" class="max-w-5xl mx-auto p-4 md:p-8 pb-40">
    
    <!-- HEADER -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
        <div class="flex items-center gap-3 w-full md:w-auto">
            <div class="bg-blue-600 p-2 rounded-lg text-white"><i data-lucide="headphones" class="w-6 h-6"></i></div>
            <div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">AI English Player</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Stable V18</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button id="viewLibBtn" class="px-4 py-2 rounded-lg text-sm font-bold bg-white border border-slate-200 text-slate-500 hover:text-blue-600 shadow-sm transition-all">Library</button>
            <button id="viewPlayBtn" class="px-4 py-2 rounded-lg text-sm font-bold bg-white border border-slate-200 text-slate-500 hover:text-blue-600 shadow-sm transition-all">Player</button>
            <button id="toggleSettings" class="p-2 text-slate-400 hover:text-blue-600 transition-colors"><i data-lucide="settings" class="w-5 h-5"></i></button>
        </div>
    </header>

    <!-- SETTINGS -->
    <div id="settingsPanel" class="hidden mb-6 p-5 bg-white rounded-2xl border-2 border-blue-100 shadow-xl">
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Gemini API Key</label>
        <div class="flex gap-2 mb-2">
            <input type="password" id="apiKey" placeholder="Enter API Key..." class="flex-1 px-3 py-2 text-sm border-2 border-slate-100 rounded-xl outline-none focus:border-blue-500 transition-all">
            <button id="saveKey" class="bg-slate-800 text-white px-5 py-2 rounded-xl text-sm font-bold hover:bg-slate-700 transition-all">Save</button>
        </div>
        <p class="text-[10px] text-slate-400 italic">Key is stored in your browser (localStorage).</p>
    </div>

    <!-- LIBRARY VIEW -->
    <div id="libraryView" class="space-y-6 animate-in fade-in duration-300">
        <div id="dropZone" class="bg-white border-2 border-dashed border-slate-300 rounded-3xl p-10 text-center hover:border-blue-400 hover:bg-blue-50/50 transition-all cursor-pointer">
            <input type="file" id="fileInput" accept="audio/*" class="hidden">
            <div id="dropMsg">
                <div class="bg-slate-100 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400"><i data-lucide="upload-cloud" class="w-7 h-7"></i></div>
                <p class="font-bold text-slate-600">Add New Lesson</p>
                <p class="text-xs text-slate-400 mt-1">MP3, WAV, M4A (Auto-analysis)</p>
            </div>
            <div id="busyMsg" class="hidden">
                <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                <p class="text-blue-600 font-bold animate-pulse">Analyzing...</p>
            </div>
        </div>
        <div>
            <div class="flex justify-between items-center mb-3 px-1">
                <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Your Collection</h2>
                <span id="libCount" class="text-[10px] font-bold bg-slate-100 px-2 py-1 rounded text-slate-500">0 Items</span>
            </div>
            <div id="libList" class="grid gap-3 grid-cols-1 md:grid-cols-2"></div>
        </div>
    </div>

    <!-- PLAYER VIEW -->
    <div id="playerView" class="hidden space-y-6 animate-in fade-in duration-300">
        <div class="bg-white rounded-3xl p-6 shadow-xl border border-slate-200 sticky top-4 z-40">
            <div class="flex justify-between items-start mb-6">
                <div class="flex items-center gap-4 overflow-hidden">
                    <div class="bg-blue-50 p-3 rounded-2xl text-blue-600 shrink-0"><i data-lucide="music" class="w-6 h-6"></i></div>
                    <div class="min-w-0">
                        <h2 id="trackTitle" class="font-bold text-lg text-slate-800 truncate">No Track</h2>
                        <div class="flex items-center gap-2 mt-1 text-xs font-mono font-bold text-slate-400">
                            <span id="currTime" class="text-blue-600">0:00</span> / <span id="totalTime">0:00</span>
                            <span id="loopStatus" class="ml-2 bg-slate-100 px-1.5 py-0.5 rounded text-[10px]">1/5</span>
                        </div>
                    </div>
                </div>
                <button id="closePlayer" class="p-2 text-slate-300 hover:text-slate-500 hover:bg-slate-100 rounded-full transition-all"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <input type="range" id="progressBar" class="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer mb-8" value="0" step="0.1">

            <div class="flex flex-col lg:flex-row items-center gap-6">
                <div class="flex items-center gap-4">
                    <button id="btnPlay" class="w-14 h-14 bg-blue-600 text-white rounded-full flex items-center justify-center hover:bg-blue-700 shadow-lg shadow-blue-200 active:scale-95 transition-all"><i data-lucide="play" class="w-6 h-6 fill-current"></i></button>
                    <button id="btnStop" class="w-10 h-10 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition-all" title="Stop & Reset"><i data-lucide="square" class="w-4 h-4 fill-current"></i></button>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 w-full">
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Mode</label>
                        <select id="selMode" class="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 outline-none focus:border-blue-500">
                            <option value="sentence">Sentence</option>
                            <option value="slash">Slash</option>
                            <option value="nonstop">Non-stop</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Wait</label>
                        <select id="selWait" class="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 outline-none focus:border-blue-500">
                            <option value="1.0">1.0x</option>
                            <option value="1.2">1.2x</option>
                            <option value="1.5">1.5x</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Link</label>
                        <select id="selOverlap" class="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 outline-none focus:border-blue-500">
                            <option value="0">0s</option>
                            <option value="0.2">0.2s</option>
                            <option value="0.5" selected>0.5s</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Speed</label>
                        <select id="selSpeed" class="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 outline-none focus:border-blue-500">
                            <option value="0.75">0.75</option>
                            <option value="1.0" selected>1.0</option>
                            <option value="1.25">1.25</option>
                        </select>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Repeat</label>
                        <select id="selRepeat" class="text-xs font-bold bg-slate-50 border border-slate-200 rounded-lg px-2 py-1.5 outline-none focus:border-blue-500">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="999">âˆž</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div id="transcriptArea" class="bg-white rounded-3xl shadow-sm border border-slate-200 p-8 min-h-[300px]"></div>
    </div>

    <!-- OVERLAY -->
    <div id="speakOverlay" class="hidden fixed bottom-12 left-1/2 -translate-x-1/2 z-[60] w-[90%] max-w-sm bg-slate-900/95 backdrop-blur-md text-white p-6 rounded-[2.5rem] shadow-2xl border border-white/10 flex items-center justify-between">
        <div class="flex items-center gap-4 text-left">
            <div class="bg-blue-600 p-3 rounded-full shadow-lg shadow-blue-500/50"><i data-lucide="mic" class="speaking-pulse w-6 h-6"></i></div>
            <div>
                <p class="text-[10px] font-black uppercase tracking-tight opacity-50">Repeat now</p>
                <p class="font-bold text-xl tracking-tight">YOUR TURN</p>
            </div>
        </div>
        <div class="text-4xl font-mono font-black text-blue-400" id="waitTimer">0.0</div>
    </div>
</div>

<div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl transform -translate-y-32 transition-all duration-500 z-[100] flex items-center gap-3 text-sm font-bold">
    <i data-lucide="info" class="w-5 h-5 text-blue-400"></i>
    <span id="toastMsg"></span>
</div>

<script>
// DB
const DB_NAME = 'EnglishApp_V18';
const STORE = 'lessons';
const dbPromise = new Promise(resolve => {
    const r = indexedDB.open(DB_NAME, 1);
    r.onupgradeneeded = e => e.target.result.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
    r.onsuccess = e => resolve(e.target.result);
});
const DB = {
    async add(file, chunks) { const db=await dbPromise; const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).add({title:file.name, date:new Date(), audio:file, chunks}); return new Promise(r=>tx.oncomplete=r); },
    async getAll() { const db=await dbPromise; return new Promise(r=>{ const req=db.transaction(STORE,'readonly').objectStore(STORE).getAll(); req.onsuccess=()=>r(req.result); }); },
    async delete(id) { const db=await dbPromise; const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete(id); return new Promise(r=>tx.oncomplete=r); }
};

// STATE
const STATE = { key: localStorage.getItem('GEMINI_API_KEY')||'', track: null, audio: new Audio(), mode: 'sentence', waitRatio: 1.0, overlap: 0.5, maxRepeats: 5, speed: 1.0, activeIdx: 0, playCount: 0, playEndTime: Infinity, isWaiting: false, raf: null, waitTimer: null, seekGuard: false };
const el = id => document.getElementById(id);
const UI = { keyIn: el('apiKey'), saveKey: el('saveKey'), panel: el('settingsPanel'), btnSet: el('toggleSettings'), libView: el('libraryView'), playView: el('playerView'), navLib: el('viewLibBtn'), navPlay: el('viewPlayBtn'), dropZone: el('dropZone'), fileIn: el('fileInput'), dropMsg: el('dropMsg'), busyMsg: el('busyMsg'), libList: el('libList'), libCount: el('libCount'), title: el('trackTitle'), curr: el('currTime'), total: el('totalTime'), loop: el('loopStatus'), close: el('closePlayer'), bar: el('progressBar'), play: el('btnPlay'), stop: el('btnStop'), mode: el('selMode'), wait: el('selWait'), link: el('selOverlap'), spd: el('selSpeed'), rep: el('selRepeat'), trans: el('transcriptArea'), overlay: el('speakOverlay'), timer: el('waitTimer'), toast: el('toast'), toastMsg: el('toastMsg') };

// UTILS
function fmt(s) { const m = Math.floor(s/60), ss = Math.floor(s%60); return `${m}:${ss.toString().padStart(2,'0')}`; }
function notify(m) { UI.toastMsg.textContent = m; UI.toast.classList.remove('-translate-y-32'); setTimeout(() => UI.toast.classList.add('-translate-y-32'), 3000); }
function setIcon(n) { const i = UI.play.querySelector('i'); if(i) { i.setAttribute('data-lucide', n); lucide.createIcons(); } }
function updateLoop() { const m = STATE.maxRepeats===999?'âˆž':STATE.maxRepeats; UI.loop.textContent = (STATE.playCount+1)+'/'+m; }
function highlight(i) {
    document.querySelectorAll('.active-chunk').forEach(e => e.classList.remove('active-chunk'));
    const el = document.getElementById('c-'+i);
    if(el) { el.classList.add('active-chunk'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
}
function cancelWait() {
    if(STATE.waitTimer) clearInterval(STATE.waitTimer);
    STATE.waitTimer = null; STATE.isWaiting = false; UI.overlay.classList.add('hidden');
}

window.onload = async () => {
    lucide.createIcons();
    if (STATE.key) UI.keyIn.value = STATE.key;
    await refreshLib();
    
    UI.saveKey.onclick = () => { STATE.key = UI.keyIn.value.trim(); localStorage.setItem('GEMINI_API_KEY', STATE.key); notify("API Key Saved"); UI.panel.classList.add('hidden'); };
    UI.btnSet.onclick = () => UI.panel.classList.toggle('hidden');
    UI.navLib.onclick = () => showView('lib'); UI.navPlay.onclick = () => showView('play'); UI.close.onclick = () => { stopAudio(); showView('lib'); };
    UI.dropZone.onclick = () => UI.fileIn.click(); UI.fileIn.onchange = uploadFile;
    UI.play.onclick = togglePlay; UI.stop.onclick = stopAudio; UI.bar.oninput = onSeek;
    
    UI.mode.onchange = () => { STATE.mode = UI.mode.value; cancelWait(); };
    UI.wait.onchange = () => STATE.waitRatio = parseFloat(UI.wait.value);
    UI.link.onchange = () => STATE.overlap = parseFloat(UI.link.value);
    UI.spd.onchange = () => STATE.audio.playbackRate = parseFloat(UI.spd.value);
    UI.rep.onchange = () => { STATE.maxRepeats = parseInt(UI.rep.value); updateLoop(); };

    STATE.audio.onloadedmetadata = () => { UI.total.textContent = fmt(STATE.audio.duration); UI.bar.max = STATE.audio.duration; };
    STATE.audio.onplay = () => { setIcon('pause'); startLoop(); };
    STATE.audio.onpause = () => { if(!STATE.isWaiting) setIcon('play'); stopLoop(); };
    STATE.audio.onended = onTrackEnd;
};

function showView(view) {
    if (view === 'lib') { UI.libView.classList.remove('hidden'); UI.playView.classList.add('hidden'); refreshLib(); }
    else { if (!STATE.track) return notify("Select a lesson first"); UI.libView.classList.add('hidden'); UI.playView.classList.remove('hidden'); renderTrans(); }
}

async function refreshLib() {
    const list = await DB.getAll(); UI.libList.innerHTML = ''; UI.libCount.textContent = list.length + ' Items';
    list.sort((a,b) => b.date - a.date).forEach(item => {
        const div = document.createElement('div');
        div.className = 'library-item bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center cursor-pointer transition-all';
        div.innerHTML = `<div class="flex items-center gap-3 overflow-hidden"><div class="bg-blue-50 text-blue-600 p-2 rounded-lg"><i data-lucide="file-audio" class="w-5 h-5"></i></div><div class="truncate"><div class="font-bold text-slate-700 truncate">${item.title}</div><div class="text-[10px] text-slate-400 uppercase font-bold">${item.chunks.length} Chunks</div></div></div><button class="del p-2 text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
        div.onclick = () => loadTrack(item);
        div.querySelector('.del').onclick = async (e) => { e.stopPropagation(); if(confirm('Delete?')) { await DB.delete(item.id); refreshLib(); } };
        UI.libList.appendChild(div);
    });
    lucide.createIcons();
}

async function uploadFile(e) {
    const file = e.target.files[0]; if(!file) return;
    if(!STATE.key) { UI.panel.classList.remove('hidden'); return notify("API Key Required"); }
    UI.dropMsg.classList.add('hidden'); UI.busyMsg.classList.remove('hidden');
    try {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const b64 = reader.result.split(',')[1];
            const prompt = `Analyze audio for 'Slash Reading'. Split into 3-7 word chunks. JSON: { "chunks": [ { "text": "...", "start": 0.0, "end": 1.5, "is_sentence_end": false } ] }. Precise timestamps.`;
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${STATE.key}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "audio/mpeg", data: b64 } }] }] }) });
            const json = await res.json();
            const text = json.candidates[0].content.parts[0].text.replace(/^```json\n?|```$/g, '').trim();
            const data = JSON.parse(text);
            data.chunks.forEach(c => c.enabled = true);
            await DB.add(file, data.chunks); notify("Saved!"); UI.fileIn.value = ''; refreshLib();
            UI.dropMsg.classList.remove('hidden'); UI.busyMsg.classList.add('hidden');
        };
    } catch(err) { console.error(err); notify("Error: Check API Key / Console"); UI.dropMsg.classList.remove('hidden'); UI.busyMsg.classList.add('hidden'); } 
}

function loadTrack(item) { STATE.track = item; STATE.audio.src = URL.createObjectURL(item.audio); UI.title.textContent = item.title; STATE.playCount = 0; STATE.playEndTime = Infinity; STATE.activeIdx = 0; updateLoop(); cancelWait(); showView('play'); }

function renderTrans() {
    UI.trans.innerHTML = ''; let box = mkBox();
    STATE.track.chunks.forEach((c, i) => {
        const sp = document.createElement('span'); sp.id = `c-${i}`;
        sp.className = `cursor-pointer px-1 rounded transition-all text-xl leading-relaxed text-slate-500 hover:text-blue-600 ${!c.enabled ? 'disabled-chunk' : ''}`;
        sp.innerHTML = `${c.text}${c.is_sentence_end ? '' : ' /'}`;
        const wrap = document.createElement('span'); wrap.className = "inline-flex items-center gap-1 group relative";
        const btn = document.createElement('button'); btn.className = `w-4 h-4 rounded-full flex items-center justify-center text-[10px] ${c.enabled ? 'text-slate-200 hover:text-blue-400' : 'text-red-400'} transition-colors`;
        btn.innerHTML = 'ðŸ‘'; btn.onclick = (e) => { e.stopPropagation(); toggleChunk(i); };
        wrap.appendChild(btn); wrap.appendChild(sp); sp.onclick = () => playFrom(i); box.appendChild(wrap);
        if (c.is_sentence_end) { UI.trans.appendChild(box); box = mkBox(); }
    });
    if(box.hasChildNodes()) UI.trans.appendChild(box);
}
function mkBox() { const d = document.createElement('div'); d.className = "sentence-container mb-4 p-2 rounded-lg flex flex-wrap gap-x-2 gap-y-1"; return d; }
function toggleChunk(i) {
    const ch = STATE.track.chunks; const target = !ch[i].enabled;
    let s=i; while(s>0 && !ch[s-1].is_sentence_end) s--;
    let e=i; while(e<ch.length-1 && !ch[e].is_sentence_end) e++;
    for(let k=s; k<=e; k++) ch[k].enabled = target;
    renderTrans();
}

/**
 * PLAYBACK ENGINE (V18) - Smart Resume
 */
function playFrom(i) {
    if (!STATE.track) return; cancelWait();
    
    // SKIP Logic
    const chunks = STATE.track.chunks;
    if (!chunks[i].enabled) {
        let next = i + 1;
        while(next < chunks.length && !chunks[next].enabled) next++;
        if (next < chunks.length) i = next; else { onTrackEnd(); return; }
    }

    STATE.activeIdx = i;
    const chunk = chunks[i];
    
    const safety = 0.1;
    const start = Math.max(0, chunk.start - STATE.overlap - safety);
    STATE.audio.currentTime = start;
    
    setStopGoal(i);
    highlight(i);
    STATE.seekGuard = true; setTimeout(()=>STATE.seekGuard=false, 300);
    STATE.audio.play().catch(console.error);
}

function setStopGoal(i) {
    const chunks = STATE.track.chunks;
    const chunk = chunks[i];
    
    if (STATE.mode === 'nonstop') {
        STATE.playEndTime = Infinity;
    } else if (STATE.mode === 'slash') {
        STATE.playEndTime = chunk.end + 0.15; // Padding
    } else {
        // Sentence mode
        let end = i;
        while(end < chunks.length && !chunks[end].is_sentence_end) end++;
        
        let targetEndChunkIdx = (end < chunks.length) ? end : chunks.length - 1;
        let baseEndTime = chunks[targetEndChunkIdx].end;

        // Gap Awareness
        let nextChunkIdx = targetEndChunkIdx + 1;
        if (nextChunkIdx < chunks.length) {
            const gap = chunks[nextChunkIdx].start - baseEndTime;
            if (gap > 2.0) {
                baseEndTime = chunks[nextChunkIdx].start - 0.1; 
            } else {
                baseEndTime += 0.2; 
            }
            if (chunks[nextChunkIdx].enabled && baseEndTime > chunks[nextChunkIdx].start) {
                baseEndTime = chunks[nextChunkIdx].start - 0.05;
            }
        } else {
            baseEndTime += 0.2;
        }
        STATE.playEndTime = baseEndTime;
    }
}

function startLoop() { if(!STATE.raf) { const f=()=>{ sync(); STATE.raf=requestAnimationFrame(f); }; STATE.raf=requestAnimationFrame(f); } }
function stopLoop() { cancelAnimationFrame(STATE.raf); STATE.raf = null; }

function sync() {
    if(!STATE.track || STATE.isWaiting) return;
    const t = STATE.audio.currentTime; UI.bar.value = t; UI.curr.textContent = fmt(t);
    const ch = STATE.track.chunks;
    
    // Highlight Logic
    let displayIdx = STATE.activeIdx;
    if (STATE.mode === 'nonstop') {
        const found = ch.findIndex(c => t >= c.start && t < c.end);
        if (found !== -1) displayIdx = found;
    } else {
        const visualT = t + 0.1; 
        let found = ch.findIndex(c => visualT >= c.start && visualT < c.end);
        if (found === -1) {
            found = ch.findIndex(c => visualT >= (c.start - STATE.overlap) && visualT < c.end);
        }

        if (found !== -1 && found > STATE.activeIdx) {
            if (!ch[found].enabled) {
                 let next = found + 1; while(next < ch.length && !ch[next].enabled) next++;
                 if (next < ch.length) { playFrom(next); return; } else { onTrackEnd(); return; }
            }
            
            // V18 FIX: Prevent advancing activeIdx prematurely in Sentence mode
            let canAdvance = true;
            if (STATE.mode === 'sentence') {
                const currentChunk = ch[STATE.activeIdx];
                // Do not update activeIdx if current chunk is end of sentence.
                // We must wait for stop logic to engage.
                if (currentChunk.is_sentence_end) {
                    canAdvance = false;
                }
            }
            
            if (canAdvance) {
                STATE.activeIdx = found;
                displayIdx = found;
                highlight(displayIdx);
            }
        }
    }
    
    if (STATE.mode === 'nonstop' && displayIdx !== -1 && ch[displayIdx].enabled) highlight(displayIdx);

    // Stop Check
    if (STATE.mode !== 'nonstop' && !STATE.seekGuard) {
        if (t >= STATE.playEndTime) {
            doPause();
            return;
        }
        
        // Overrun Protection
        if (STATE.activeIdx !== -1) {
             let nextIdx = STATE.activeIdx + 1;
             while(nextIdx < ch.length && !ch[nextIdx].enabled) nextIdx++;
             if (nextIdx < ch.length) {
                 if (t >= ch[nextIdx].start + 0.05) {
                     doPause();
                 }
             }
        }
    }
}

function doPause() {
    STATE.audio.pause(); STATE.isWaiting = true;
    
    let dur = 0;
    if (STATE.mode === 'slash') {
        const c = STATE.track.chunks[STATE.activeIdx]; dur = c.end - c.start;
    } else {
        let endIdx = STATE.activeIdx; 
        let startIdx = endIdx;
        while(startIdx > 0 && !STATE.track.chunks[startIdx-1].is_sentence_end) startIdx--;
        if (STATE.track.chunks[endIdx]) {
            dur = STATE.track.chunks[endIdx].end - STATE.track.chunks[startIdx].start;
        }
    }
    
    const ms = dur * 1000 * STATE.waitRatio;
    UI.overlay.classList.remove('hidden');
    let rem = ms / 1000; UI.timer.textContent = rem.toFixed(1);
    
    STATE.waitTimer = setInterval(() => {
        rem -= 0.1;
        if (rem <= 0) {
            cancelWait();
            // Find NEXT sentence/chunk to play
            let next = STATE.activeIdx + 1;
            
            // In Sentence mode, if activeIdx is somehow pointing to start of next sentence (overrun case),
            // we should not skip it. But normally activeIdx is kept at end of sentence by V18 fix.
            
            if (next < STATE.track.chunks.length) {
                playFrom(next);
            } else {
                onTrackEnd();
            }
        } else UI.timer.textContent = Math.max(0, rem).toFixed(1);
    }, 100);
}

function onTrackEnd() {
    STATE.playCount++;
    if (STATE.maxRepeats === 999 || STATE.playCount < STATE.maxRepeats) {
        updateLoop(); playFrom(0);
    } else {
        stopAudio();
    }
}

function stopAudio() { cancelWait(); STATE.audio.pause(); STATE.audio.currentTime = 0; STATE.activeIdx = 0; STATE.playEndTime = Infinity; STATE.playCount = 0; updateLoop(); document.querySelectorAll('.active-chunk').forEach(e => e.classList.remove('active-chunk')); }

function onSeek() {
    STATE.audio.currentTime = UI.bar.value;
    const t = UI.bar.value;
    const i = STATE.track.chunks.findIndex(c => t >= c.start && t < c.end);
    if(i !== -1) {
        STATE.activeIdx = i;
        if(STATE.mode !== 'nonstop') setStopGoal(i);
    }
    cancelWait();
}

function togglePlay() { 
    if (STATE.audio.paused) { 
        if(STATE.isWaiting) { cancelWait(); let next = STATE.activeIdx + 1; if (next < STATE.track.chunks.length) playFrom(next); }
        else { if(STATE.playEndTime === -1 && STATE.mode !== 'nonstop') playFrom(STATE.activeIdx); else STATE.audio.play(); } 
    } else STATE.audio.pause(); 
}
function toBase64(f) { return new Promise((r, j) => { const rd = new FileReader(); rd.readAsDataURL(f); rd.onload = () => r(rd.result.split(',')[1]); rd.onerror = j; }); }
</script>
</body>
</html>
