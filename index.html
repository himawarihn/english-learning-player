<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Listening Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .active-segment { 
            background-color: #dbeafe; 
            border-left: 4px solid #2563eb; 
            transform: translateX(4px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .segment-item { transition: all 0.15s ease-out; }
        .segment-text { transition: color 0.1s; }
        .active-segment .segment-text { color: #1e40af; font-weight: 600; }
        .skipped-segment { opacity: 0.3; background-color: #f1f5f9; }
        .skipped-segment .segment-text { text-decoration: line-through; }
        .speaking-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        #transcriptList {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8 pb-32">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 flex items-center justify-center gap-2">
                <i data-lucide="headphones" class="text-blue-600"></i>
                AI English Listening Player
            </h1>
            <div id="apiSettings" class="mt-4 flex flex-col items-center gap-2">
                <div class="flex items-center gap-2 bg-white p-1 rounded-lg border border-slate-200 shadow-sm w-full max-w-sm">
                    <input type="password" id="apiKeyInput" placeholder="Gemini API Key を入力" class="flex-1 px-3 py-1.5 text-sm outline-none">
                    <button id="saveKeyBtn" class="bg-slate-800 text-white px-4 py-1.5 rounded-md text-sm font-medium hover:bg-slate-700 transition">Save</button>
                </div>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest">API Key is stored only in your browser</p>
            </div>
        </header>

        <main class="space-y-6">
            <!-- Upload Area -->
            <div id="uploadZone" class="bg-white border-2 border-dashed border-slate-300 rounded-2xl p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
                <input type="file" id="audioInput" accept="audio/*" class="hidden">
                <div id="uploadPrompt">
                    <i data-lucide="upload-cloud" class="mx-auto w-12 h-12 text-slate-400 mb-4"></i>
                    <p class="text-lg font-medium text-slate-700">音声ファイルをアップロード</p>
                    <p class="text-sm text-slate-400">AIが音声を解析してセンテンスごとに同期させます</p>
                </div>
                <div id="transcribingState" class="hidden">
                    <div class="flex flex-col items-center">
                        <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p class="text-lg font-medium text-blue-600">AIが高精度同期解析を実行中...</p>
                        <p class="text-sm text-slate-400">文字起こしを行っています（10〜30秒）</p>
                    </div>
                </div>
            </div>

            <!-- Player Container -->
            <div id="playerContainer" class="hidden space-y-4">
                <!-- Speaking Timer Overlay -->
                <div id="speakingTimer" class="hidden fixed bottom-8 left-1/2 -translate-x-1/2 z-50 w-[90%] max-w-md bg-blue-600 text-white p-4 rounded-2xl shadow-2xl flex items-center justify-between px-8 border-2 border-blue-400">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-500 p-2 rounded-full">
                            <i data-lucide="mic" class="speaking-pulse w-5 h-5 text-white"></i>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase tracking-widest opacity-80 font-bold">Repeat Mode</span>
                            <span class="font-bold text-lg leading-tight">YOUR TURN</span>
                        </div>
                    </div>
                    <div class="text-3xl font-mono font-bold" id="timerSeconds">0.0s</div>
                </div>

                <!-- Controls -->
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <button id="playPauseBtn" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 transition shadow-md">
                                <i data-lucide="play"></i>
                            </button>
                            <div class="space-y-1">
                                <div class="text-xs text-slate-500 flex justify-between font-mono">
                                    <span id="currentTime">0:00</span>
                                    <span id="duration">0:00</span>
                                </div>
                                <input type="range" id="seekSlider" class="w-48 md:w-64 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                            </div>
                        </div>

                        <div class="flex items-center gap-4 lg:gap-6 flex-wrap">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter">Speed</span>
                                <select id="speedSelect" class="text-sm font-medium bg-slate-100 border-none rounded-md px-2 py-1 outline-none">
                                    <option value="0.5">0.5x</option>
                                    <option value="0.75">0.75x</option>
                                    <option value="1.0" selected>1.0x</option>
                                    <option value="1.25">1.25x</option>
                                    <option value="1.5">1.5x</option>
                                </select>
                            </div>

                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter">Pause</span>
                                <select id="pauseRatioSelect" class="text-sm font-medium bg-slate-100 border-none rounded-md px-2 py-1 outline-none">
                                    <option value="1.0" selected>1.0x</option>
                                    <option value="1.1">1.1x</option>
                                    <option value="1.2">1.2x</option>
                                    <option value="1.3">1.3x</option>
                                    <option value="1.4">1.4x</option>
                                    <option value="1.5">1.5x</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter">Slash</span>
                                <button id="slashToggle" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-sm font-medium transition hover:bg-slate-200 active:scale-95">
                                    <i data-lucide="scissors" class="w-4 h-4"></i>
                                    <span id="slashText">Off</span>
                                </button>
                            </div>

                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-400 uppercase tracking-tighter">Mode</span>
                                <button id="modeToggle" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-100 text-sm font-medium transition active:scale-95 border-2 border-transparent shadow-sm">
                                    <i data-lucide="list-music" class="w-4 h-4"></i>
                                    <span id="modeText">一括再生</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- A-B Repeat -->
                    <div class="mt-6 flex items-center gap-4 pt-4 border-t border-slate-100">
                        <span class="text-xs font-bold text-slate-400 uppercase">A-B Repeat</span>
                        <button id="setStartBtn" class="px-3 py-1 border border-slate-300 rounded text-xs hover:bg-slate-50 font-medium">Point A</button>
                        <button id="setEndBtn" class="px-3 py-1 border border-slate-300 rounded text-xs hover:bg-slate-50 font-medium">Point B</button>
                        <button id="clearRepeatBtn" class="text-slate-400 hover:text-red-500 transition">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                        </button>
                        <div id="repeatStatus" class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded hidden">
                            Looping: <span id="loopDisplay" class="font-mono">0:00 - 0:00</span>
                        </div>
                    </div>
                </div>

                <!-- Transcription -->
                <div id="transcriptionView" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-semibold text-slate-600">Transcription</span>
                            <span id="slashBadge" class="hidden px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded uppercase">Slash Mode</span>
                        </div>
                        <span class="text-xs text-slate-400 italic">クリックしてジャンプ再生</span>
                    </div>
                    <div id="transcriptList" class="max-h-[60vh] overflow-y-auto p-2 divide-y divide-slate-50">
                        <!-- Segments -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Error/Toast -->
    <div id="errorToast" class="fixed bottom-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 flex items-center gap-3">
        <i data-lucide="alert-circle"></i>
        <span id="errorMessage">エラーが発生しました</span>
    </div>

    <script>
        let apiKey = localStorage.getItem('GEMINI_API_KEY') || ""; 
        let audioPlayer = new Audio();
        let segments = [];
        let isSlashMode = false;
        let repeatPoints = { start: null, end: null };
        let playbackMode = 'continuous'; 
        let currentActiveId = -1;
        let lastStoppedId = -1;
        let pauseTimerInterval = null;
        let isWaitingForNext = false;
        let animationFrameId = null;
        let pauseRatio = 1.0;

        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveKeyBtn = document.getElementById('saveKeyBtn');
        const audioInput = document.getElementById('audioInput');
        const uploadZone = document.getElementById('uploadZone');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const transcribingState = document.getElementById('transcribingState');
        const playerContainer = document.getElementById('playerContainer');
        const transcriptList = document.getElementById('transcriptList');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const seekSlider = document.getElementById('seekSlider');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const speedSelect = document.getElementById('speedSelect');
        const pauseRatioSelect = document.getElementById('pauseRatioSelect');
        const modeToggle = document.getElementById('modeToggle');
        const modeText = document.getElementById('modeText');
        const slashToggle = document.getElementById('slashToggle');
        const slashText = document.getElementById('slashText');
        const slashBadge = document.getElementById('slashBadge');
        const speakingTimer = document.getElementById('speakingTimer');
        const timerSeconds = document.getElementById('timerSeconds');
        const setStartBtn = document.getElementById('setStartBtn');
        const setEndBtn = document.getElementById('setEndBtn');
        const clearRepeatBtn = document.getElementById('clearRepeatBtn');
        const repeatStatus = document.getElementById('repeatStatus');
        const loopDisplay = document.getElementById('loopDisplay');
        const errorToast = document.getElementById('errorToast');
        const errorMessage = document.getElementById('errorMessage');

        window.onload = () => {
            if (apiKey) apiKeyInput.value = apiKey;
            lucide.createIcons();
            setupEventListeners();
        };

        function setupEventListeners() {
            saveKeyBtn.onclick = () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    apiKey = key;
                    localStorage.setItem('GEMINI_API_KEY', key);
                    showError("API Key saved to browser storage.");
                }
            };

            uploadZone.onclick = () => audioInput.click();
            audioInput.onchange = handleFileUpload;
            playPauseBtn.onclick = togglePlay;
            
            audioPlayer.onplay = () => { syncPlayIcon('pause'); startSyncLoop(); };
            audioPlayer.onpause = () => { if (!isWaitingForNext) syncPlayIcon('play'); stopSyncLoop(); };
            audioPlayer.onloadedmetadata = () => { durationEl.textContent = formatTime(audioPlayer.duration); seekSlider.max = audioPlayer.duration; };

            seekSlider.oninput = () => {
                audioPlayer.currentTime = seekSlider.value;
                lastStoppedId = -1; clearPauseTimer(); isWaitingForNext = false; updateUIState();
            };

            speedSelect.onchange = () => audioPlayer.playbackRate = parseFloat(speedSelect.value);
            pauseRatioSelect.onchange = () => pauseRatio = parseFloat(pauseRatioSelect.value);

            modeToggle.onclick = () => {
                playbackMode = playbackMode === 'continuous' ? 'paused' : 'continuous';
                modeText.textContent = playbackMode === 'continuous' ? '一括再生' : '文ごとに停止';
                modeToggle.classList.toggle('border-blue-600', playbackMode === 'paused');
                modeToggle.classList.toggle('bg-blue-50', playbackMode === 'paused');
                if (playbackMode !== 'paused') { clearPauseTimer(); isWaitingForNext = false; }
                const icon = modeToggle.querySelector('[data-lucide]');
                if (icon) { icon.setAttribute('data-lucide', playbackMode === 'paused' ? 'pause-octagon' : 'list-music'); lucide.createIcons(); }
            };

            slashToggle.onclick = () => {
                isSlashMode = !isSlashMode;
                slashText.textContent = isSlashMode ? 'On' : 'Off';
                slashBadge.classList.toggle('hidden', !isSlashMode);
                renderTranscription();
            };

            setStartBtn.onclick = () => { repeatPoints.start = audioPlayer.currentTime; updateRepeatUI(); };
            setEndBtn.onclick = () => { repeatPoints.end = audioPlayer.currentTime; updateRepeatUI(); };
            clearRepeatBtn.onclick = () => { repeatPoints = { start: null, end: null }; updateRepeatUI(); };
        }

        function startSyncLoop() {
            if (animationFrameId) return;
            const loop = () => { updateUIState(); animationFrameId = requestAnimationFrame(loop); };
            animationFrameId = requestAnimationFrame(loop);
        }

        function stopSyncLoop() { if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; } }

        function syncPlayIcon(name) {
            const icon = playPauseBtn.querySelector('[data-lucide]');
            if (icon) { icon.setAttribute('data-lucide', name); lucide.createIcons(); }
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file || !apiKey) { if(!apiKey) showError("API Keyを設定してください"); return; }
            uploadPrompt.classList.add('hidden'); transcribingState.classList.remove('hidden'); uploadZone.classList.add('pointer-events-none');
            try {
                const base64Audio = await fileToBase64(file);
                audioPlayer.src = URL.createObjectURL(file);
                segments = await requestTranscription(base64Audio);
                segments = segments.map(seg => ({ ...seg, enabled: true }));
                renderTranscription();
                uploadZone.classList.add('hidden'); playerContainer.classList.remove('hidden');
            } catch (err) {
                showError("解析に失敗しました。Keyを確認してください");
                uploadPrompt.classList.remove('hidden'); transcribingState.classList.add('hidden'); uploadZone.classList.remove('pointer-events-none');
            }
        }

        async function requestTranscription(base64Data) {
            const systemPrompt = `Analyze the audio and transcribe in English. Return JSON 'segments' array with text, slashed_text, start, end. Each segment is one sentence. Accurate timestamps are critical.`;
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: "Transcribe precisely." }, { inlineData: { mimeType: "audio/mpeg", data: base64Data.split(',')[1] } }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const data = await response.json();
            return JSON.parse(data.candidates[0].content.parts[0].text).segments;
        }

        function renderTranscription() {
            transcriptList.innerHTML = '';
            segments.forEach((seg, idx) => {
                const div = document.createElement('div');
                div.id = `seg-${idx}`;
                const isSkipped = !seg.enabled;
                div.className = `group flex p-4 cursor-pointer transition-all duration-200 border-l-4 border-transparent hover:bg-slate-50 segment-item ${isSkipped ? 'skipped-segment' : ''}`;
                let displayText = isSlashMode ? seg.slashed_text.split('/').map(p => p.trim()).filter(p => p.length > 0).join(' /<br>') : seg.text;
                div.innerHTML = `
                    <div class="flex items-start gap-4 w-full">
                        <button class="skip-btn mt-1 text-slate-300 hover:text-blue-500 transition-colors"><i data-lucide="${isSkipped ? 'eye-off' : 'eye'}" class="w-4 h-4"></i></button>
                        <span class="text-xs font-mono text-slate-400 mt-1.5 min-w-[35px] font-medium">${formatTime(seg.start)}</span>
                        <p class="text-lg leading-relaxed text-slate-700 font-medium segment-text flex-1">${displayText}</p>
                    </div>
                `;
                div.querySelector('.skip-btn').onclick = (e) => { e.stopPropagation(); seg.enabled = !seg.enabled; renderTranscription(); };
                div.onclick = () => { if (seg.enabled) { clearPauseTimer(); lastStoppedId = -1; isWaitingForNext = false; audioPlayer.currentTime = seg.start; audioPlayer.play().then(() => updateUIState()); } };
                transcriptList.appendChild(div);
            });
            lucide.createIcons();
        }

        function updateUIState() {
            const time = audioPlayer.currentTime;
            seekSlider.value = time; currentTimeEl.textContent = formatTime(time);
            if (repeatPoints.start !== null && repeatPoints.end !== null && time >= repeatPoints.end) { audioPlayer.currentTime = repeatPoints.start; return; }

            let foundIdx = segments.findIndex(s => time >= s.start && time < s.end);
            if (foundIdx === -1) { for (let i = segments.length - 1; i >= 0; i--) { if (time >= segments[i].end) { foundIdx = i; break; } } }

            if (foundIdx !== -1 && foundIdx !== currentActiveId) {
                if (currentActiveId !== -1) { const prev = document.getElementById(`seg-${currentActiveId}`); if (prev) prev.classList.remove('active-segment'); }
                const next = document.getElementById(`seg-${foundIdx}`);
                if (next && segments[foundIdx].enabled) { next.classList.add('active-segment'); next.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
                currentActiveId = foundIdx;
            }

            if (foundIdx !== -1 && !segments[foundIdx].enabled && !audioPlayer.paused) {
                const nIdx = segments.findIndex((s, i) => i > foundIdx && s.enabled);
                if (nIdx !== -1) audioPlayer.currentTime = segments[nIdx].start; else audioPlayer.pause();
                return;
            }

            if (playbackMode === 'paused' && currentActiveId !== -1 && !audioPlayer.paused) {
                const seg = segments[currentActiveId];
                if ((time >= seg.end - 0.05) && lastStoppedId !== currentActiveId) stopAndStartTimer(currentActiveId);
            }
        }

        function stopAndStartTimer(idx) {
            audioPlayer.pause(); isWaitingForNext = true; lastStoppedId = idx;
            const seg = segments[idx];
            startPauseTimer((seg.end - seg.start) * 1000 * pauseRatio);
        }

        function startPauseTimer(durationMs) {
            clearPauseTimer(); speakingTimer.classList.remove('hidden'); isWaitingForNext = true;
            let remaining = durationMs / 1000; timerSeconds.textContent = remaining.toFixed(1) + 's';
            pauseTimerInterval = setInterval(() => {
                remaining -= 0.1;
                if (remaining <= 0) {
                    clearPauseTimer();
                    if (playbackMode === 'paused') {
                        const nIdx = segments.findIndex((s, i) => i > lastStoppedId && s.enabled);
                        if (nIdx !== -1) audioPlayer.currentTime = segments[nIdx].start;
                        audioPlayer.play().then(() => { isWaitingForNext = false; });
                    }
                } else { timerSeconds.textContent = Math.max(0, remaining).toFixed(1) + 's'; }
            }, 100);
        }

        function clearPauseTimer() { if (pauseTimerInterval) clearInterval(pauseTimerInterval); pauseTimerInterval = null; speakingTimer.classList.add('hidden'); }

        function togglePlay() {
            if (audioPlayer.paused) {
                if (isWaitingForNext) {
                    clearPauseTimer(); isWaitingForNext = false;
                    const nIdx = segments.findIndex((s, i) => i > lastStoppedId && s.enabled);
                    if (nIdx !== -1) audioPlayer.currentTime = segments[nIdx].start;
                }
                audioPlayer.play();
            } else audioPlayer.pause();
        }

        function updateRepeatUI() {
            if (repeatPoints.start !== null && repeatPoints.end !== null) {
                if (repeatPoints.start > repeatPoints.end) [repeatPoints.start, repeatPoints.end] = [repeatPoints.end, repeatPoints.start];
                repeatStatus.classList.remove('hidden'); loopDisplay.textContent = `${formatTime(repeatPoints.start)} - ${formatTime(repeatPoints.end)}`;
            } else repeatStatus.classList.add('hidden');
        }

        function formatTime(s) { const m = Math.floor(s / 60); return `${m}:${Math.floor(s % 60).toString().padStart(2, '0')}`; }
        function fileToBase64(file) { return new Promise((r, j) => { const f = new FileReader(); f.readAsDataURL(file); f.onload = () => r(f.result); f.onerror = e => j(e); }); }
        function showError(m) { errorMessage.textContent = m; errorToast.classList.remove('translate-y-20'); setTimeout(() => errorToast.classList.add('translate-y-20'), 5000); }
    </script>
</body>
</html>